name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x]

    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build application
      run: npm run build
    
    - name: Run unit tests
      run: npm test
    
    - name: Start application
      run: npm start &
      env:
        OLLAMA_BASE_URL: http://localhost:11434
        MODEL_NAME: llama3.1
    
    - name: Wait for app to start
      run: |
        timeout 30 bash -c 'until curl -f http://localhost:3000/api/health; do sleep 1; done'
    
    - name: Run Lighthouse CI
      run: |
        npx @lhci/cli autorun
        # Check PWA score
        PWA_SCORE=$(npx @lhci/cli collect --url=http://localhost:3000 | grep "Progressive Web App" | awk '{print $2}' | sed 's/\.//')
        if [ "$PWA_SCORE" -lt 90 ]; then
          echo "PWA score $PWA_SCORE is below threshold of 90"
          exit 1
        fi
    
    - name: Stop application
      run: pkill -f "next start" || true
